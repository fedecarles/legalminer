{% extends 'base.html' %}
{% load bootstrap3 %}
{% block content %}
<body>
    <div class="container-fluid">
	<div class="row">
		<div class="col-md-12">
			<h4 class="text-center">
                Panel para b√∫squeda: {{ query }}
			</h4>
		</div>
	</div>
	<div class="dc-data-count row">
		<div class="col-md-3">
			<blockquote>
            <small>Total</small>
			<span class="total-count bq-number"></span> 
			</blockquote>
		</div>
		<div class="col-md-3">
			<blockquote>
            <small>Filtrado</small>
			<span class="filter-count bq-number"></span> 
			</blockquote>
		</div>
		<div class="col-md-3">
			<blockquote>
            <small>Juez:</small>
				<p>
				</p> <small>% del fallos.</small>
			</blockquote>
		</div>
		<div class="col-md-3">
			<blockquote>
				<p>
					Lorem ipsum dolor sit amet, consectetur adipiscing elit. Integer posuere erat a ante.
				</p> <small>Someone famous <cite>Source Title</cite></small>
			</blockquote>                                                                                        
		</div>                                                                                           	</div>
	<div class="row">
		<div id="main-chart" class="col-md-8">
			<h4>
				Heading
			</h4>
		</div>
		<div id="main-right-chart" class="col-md-4">
			<h4>
				Heading
			</h4>
		</div>
	</div>
	<div class="row">
		<div id="medium-left-chart">
			<h4>
				Heading
			</h4>
		</div>
		<div id="medium-center-chart">
			<h4>
				Heading
			</h4>
		</div>
        <div id="medium-right-chart">
			<h4>
				Heading
			</h4>
		</div>
	</div>
</div>
</body>

<script type="text/javascript">
var data = {{ case_data|safe }}
var map_count = {{ map_count|safe }}

var dtgFormat = d3.time.format("%Y-%m-%d");

data.forEach(function(d) { 
  d.fecha   = dtgFormat.parse(d.fecha); 
});

// http://stackoverflow.com/questions/17524627/is-there-a-way-to-tell-crossfilter-to-treat-elements-of-array-as-separate-record
function reduceAdd(p, v) {
  v.jueces.forEach (function(val, idx) {
     p[val] = (p[val] || 0) + 1; //increment counts
  });
  return p;
}

function reduceRemove(p, v) {
  v.jueces.forEach (function(val, idx) {
     p[val] = (p[val] || 0) - 1; //decrement counts
  });
  return p;
}

function reduceInitial() {
  return {};  
}

var ndx = crossfilter(data); 

var dateDim = ndx.dimension(function(d) {return d.fecha;});
var corteDim = ndx.dimension(function(d) {return d.corte;});
var provinciaDim = ndx.dimension(function(d) {return d.provincia;});
var juecesDim = ndx.dimension(function(d) {return d.jueces;});
var mapDim = ndx.dimension(function(d) {return d.provincia;});

var dateGroup = dateDim.group()
var corteGroup = corteDim.group().reduceCount(function(d) {return d.corte;});
var provinciaGroup = provinciaDim.group().reduceCount(function(d) {return d.provincia;});
var juecesGroup = juecesDim.groupAll().reduce(reduceAdd, reduceRemove, reduceInitial).value();
var mapGroup = mapDim.group().reduceCount(function(d) {return d.provincia;});
var all = ndx.groupAll();

// hack to make dc.js charts work
juecesGroup.all = function() {
  var newObject = [];
  for (var key in this) {
    if (this.hasOwnProperty(key) && key != "all" && key != "top") {
      newObject.push({
        key: key,
        value: this[key]
      });
    }
  }
  return newObject;
};


juecesGroup.top = function(count) {
    var newObject = this.all();
     newObject.sort(function(a, b){return b.value - a.value});
    return newObject.slice(0, count);
};

var minDate = dateDim.bottom(1)[0].fecha;
var maxDate = dateDim.top(1)[0].fecha;

var mainChart  = dc.lineChart("#main-chart");
var leftChart  = dc.rowChart("#medium-left-chart");
var centerChart  = dc.rowChart("#medium-center-chart");
var mainRightChart  = dc.rowChart("#main-right-chart");
var totalCount = dc.dataCount(".dc-data-count");

var mainChart_width = $('#main-chart').width(),
    mainChart_height = $('#main-chart').height() * .9;

var mainRigthChart_width = $('#main-right-chart').width(),
    mainRightChart_height = $('#main-right-chart').height() * .9;

var leftChart_width = $('#medium-left-chart').width(),
    leftChart_height = $('#medium-left-chart').height() * .9;

var centerChart_width = $('#medium-center-chart').width(),
    centerChart_height = $('#medium-center-chart').height() * .9;

mainChart
	.width(mainChart_width).height(mainChart_height)
	.dimension(dateDim)
	.group(dateGroup)
	.x(d3.time.scale().domain([minDate,maxDate]))
    .xUnits(function(){return 100;});

mainRightChart
	.width(mainRigthChart_width).height(mainRightChart_height)
	.dimension(juecesDim)
	.group(juecesGroup)
    .cap(9)
    .ordering(function(d){ return -d.value })
    .colors("#4682b4")
    .xAxis().ticks(4);

mainRightChart.filterHandler (function (dimension, filters) {
   dimension.filter(null);   
    if (filters.length === 0)
        dimension.filter(null);
    else
        dimension.filterFunction(function (d) {
            for (var i=0; i < d.length; i++) {
                if (filters.indexOf(d[i]) >= 0) return true;
            }
            return false; 
        });
  return filters; 
  }
);

leftChart
	.width(leftChart_width).height(leftChart_height)
    .data(function (group) {return corteGroup.top(10);})
	.dimension(corteDim)
	.group(corteGroup)
    .ordering(function(d){ return -d.value })
    .colors("#4682b4")
    .xAxis().ticks(4);

centerChart
	.width(centerChart_width).height(centerChart_height)
	.dimension(provinciaDim)
	.group(provinciaGroup)
    .ordering(function(d){ return -d.value })
    .colors("#4682b4")
    .xAxis().ticks(4);

totalCount
    .dimension(ndx)
    .group(all);

dc.renderAll(); 

var width = $('#medium-right-chart').width() / 2,
    height = $('#medium-right-chart').height(),
    active = d3.select(null);

var argMap = dc.geoChoroplethChart("#medium-right-chart");

d3.json("/static/js/argentina.json", function(geojson){
        argMap
            .dimension(mapDim)
            .group(mapGroup)
            .width(400)
            .height(400)
            .colors(d3.scale.linear()
                   .range(["#ecf2f7", "#4682b4"])
                    )
            .colorDomain([0, 500])
            .colorCalculator(function (d) { return d ? argMap.colors()(d) : '#ccc';}) 
            .transitionDuration(1000)
            .projection(d3.geo.transverseMercator()
                    .center([4, -40.5])
                    .rotate([66, 0])
                    .scale((height * 45) / 33)
                    .translate([(width / 2), (height / 2)])
                    )
            .overlayGeoJson(geojson.features, 'NAME_1', function(d) {
                return d.properties.NAME_1.toUpperCase();
            }) 

            dc.renderAll();
        });
</script>
{% endblock %}
