{% load bootstrap3 %}
{% block content %}
<div id="toolbar">
    <div class="col-md-offset-5 doc-toolbar">
        <a href="#" data-toggle="modal" data-target="#myModal">
           <i class="fa fa-ellipsis-h" aria-hidden="true" title="Datos Adicionales"></i>
        </a>
        <a class="fav-btn" href="#" name="{{ instance.id }}">
           {% if not liked %}
           <i class="fa fa-star-o" aria-hidden="true" title="Guardar como Favorito"></i>
           {% else %}
           <i class="fa fa-star" aria-hidden="true" title="Remover Favorito"></i>
           {% endif %}
        </a>
        <a id="notas-off" href="#">
           <i class="fa fa-pencil-square-o" aria-hidden="true" title="Anotar Texto"></i>
        </a>
        <a id="notas-on" href="#">
           <i class="fa fa-pencil-square-o" aria-hidden="true"></i>
        </a>
        <a href="#">
           <i class="fa fa-download" aria-hidden="true" title="Bajar Texto"></i>
        </a>
    </div>
    <div id="text-tools" class="col-md-offset-5 doc-toolbar">
        <a id="hl-on" href="#">
           <i class="fa fa-pencil" aria-hidden="true" title="Resaltador"></i>
        </a>
        <a id="hl-off" href="#">
           <i class="fa fa-pencil-square" aria-hidden="true" title="Resaltador"></i>
        </a>
        <a id="cm-on" href="#">
           <i class="fa fa-comment-o" aria-hidden="true" title="Insertar Comentario"></i>
        </a>
        <a id="save" href="#" data-toggle="modal" data-target="#note_confirmation">
           <i class="fa fa-floppy-o" aria-hidden="true" title="Guardar Anotaciones"></i>
        </a>
    </div>
</div>
<div id="text-view">
    <h3 id="titulo">{{ instance.autos }}</h3>
    <pre id="texto-completo" class="col-md-offset-2">{{ instance.text|safe }}</pre>
</div>

<!-- Modal -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
        <h4 class="modal-title" id="myModalLabel">Datos adicionales</h4>
      </div>
      <div class="modal-body">
          <table id="desc_table" class="table table-hover">
              <tr>
                  <td>Carátula:</td>
                  <td>{{ instance.autos }}</td>
              </tr>
              <tr>
                  <td>Fecha:</td>
                  <td>{{ instance.fecha|date:"SHORT_DATE_FORMAT" }}</td>
              </tr>
              <tr>
                  <td>Tribunal:</td>
                  <td>{{ instance.corte }}</td>
              </tr>
              <tr>
                  <td>Jueces:</td>
                  <td>{{ instance.jueces }}</td>
              </tr>
              <tr>
                  <td>Legislación:</td>
                  <td>{{ instance.leyes }}</td>
              </tr>
              <tr>
                  <td>Fallos:</td>
                  <td>{{ instance.citados }}</td>
               <tr>
                  <td>Decisión:</td>
                  <td>{{ instance.resultados }}</td>
              </tr>
             </tr>
          </table>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="note_confirmation" tabindex="-1" role="dialog" aria-labelledby="modal_note" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modal_note">Anotaciones Guardadas</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Tus anotaciones fueron guardadas. Puedes acceder a ellas en cualquier momento desde tu perfil</p>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

// Highlight search word in case text.
$(document).ready(function() {
    $('.highlighted').each(function() {
        $('#details pre').mark($(this).text(),
                {"className": 'highlighted'});
    });
    $('#hl-off').hide();
    $('#text-tools').hide();
    $('#notas-on').hide();
});

// FAV / UNFAV BUTTON
$('.fav-btn').click(function(){
    $.ajax({
        type: "POST",
        url: "{% url 'like_button' %}",
        data: {'pk': $(this).attr('name'), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
        dataType: "json",
        success: function(response) {
            if (response.liked == false){
                $('.fav-btn').html('<i class="fa fa-star-o" aria-hidden="true"></i>')
            } else{
                $('.fav-btn').html('<i class="fa fa-star" aria-hidden="true"></i>')
            };
        },
        error: function(rs, e) {
        }
    });
})
       
$('#hl-on').on('click', function() {
    $('#hl-off').show();
    $('#hl-on').hide();
    hlText();
});

$('#hl-off').on('click', function() {
    $('#hl-on').show();
    $('#hl-off').hide();
    $('#texto-completo').unbind();
});

///// EDIT TOOLS /////

// Get date
var user = "{{request.user}}";
var d = new Date();
var month = d.getMonth()+1;
var day = d.getDate();

var cmdate = (day<10 ? '0' : '') + day + '/' +
    (month<10 ? '0' : '') + month + '/' +
    d.getFullYear() 


// Text Hightlight function.
function hlText() {
    $('pre').on("mouseup", function (e) {
        var selected = getSelection();
        var range = selected.getRangeAt(0);
        console.log(range);
        if(selected.toString().length > 1){
            var newNode = document.createElement("span");
            newNode.setAttribute("class", "text-hl");
            range.surroundContents(newNode); 
        }
        selected.removeAllRanges();
    });
}

function getSelection() {
    var seltxt = '';
    if ($('#details').getSelection) { 
        seltxt = $('#details').getSelection(); 
    } else if (document.getSelection) { 
        seltxt = document.getSelection(); 
    } else if (document.selection) { 
        seltxt = document.selection.createRange().text; 
    }
    else return;
    return seltxt;
}

// Add comments to text on mouse position click.
$('#cm-on').on('click', function() {
    $('texto-completo').focus();
    pasteHtmlAtCaret("<p><div contenteditable=true class='comment'>" + cmdate + " " + user + ": " + "</div></p>");
    $('.comment').focus();
});

function pasteHtmlAtCaret(html) {
    var sel, range;
    if (window.getSelection) {
        sel = window.getSelection();
        if (sel.getRangeAt && sel.rangeCount) {
            range = sel.getRangeAt(0);
            range.deleteContents();

            var el = document.createElement("div");
            el.innerHTML = html;
            var frag = document.createDocumentFragment(), node, lastNode;
            while ( (node = el.firstChild) ) {
                lastNode = frag.appendChild(node);
            }
            range.insertNode(frag);

            if (lastNode) {
                range = range.cloneRange();
                range.setStartAfter(lastNode);
                range.collapse(true);
                sel.removeAllRanges();
                sel.addRange(range);
            }
        }
    } else if (document.selection && document.selection.type != "Control") {
        document.selection.createRange().pasteHTML(html);
    }
}

$('#notas-off').on('click', function(){
    $('#notas-on').show();
    $('#notas-off').hide();
    $('#text-tools').slideToggle(300);
    $('#texto-completo').attr('contenteditable', true);
});

$('#notas-on').on('click', function(){
    $('#notas-on').hide();
    $('#notas-off').show();
    $('#text-tools').slideToggle(300);
    $('#texto-completo').attr('contenteditable', false);
});

///// SAVE NOTES /////
$('#save').click(function(){
    $.ajax({
        type: "POST",
        url: "{% url 'savenotes' %}",
        data: {'autos': $('#titulo').text(), 'text': $('#texto-completo').html(), 'csrfmiddlewaretoken': '{{ csrf_token }}'},
        dataType: "json",
        success: function(response) {
        },
        error: function(rs, e) {
        }
    });
})


</script>
{% endblock %}
